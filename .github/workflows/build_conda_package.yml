---
# .github/workflows/build-conda.yml
name: Build and Upload Conda Package
on:
  push:
      tags:
      - "v*"
  workflow_dispatch:
jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          echo "Using tag version..."
          LATEST_TAG="${GITHUB_REF_NAME#v}"
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV

      - name: Get branch name for version
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "Branch name: ${{ github.ref_name }}..."
          echo "LATEST_TAG=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: Get current commit SHA
        run: |
          echo "Using checked-out commit..."
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_ENV

      - name: Update recipe.yaml with latest rev and version
        run: |
          echo "Updating recipe.yaml with commit: $COMMIT_SHA and tag: $LATEST_TAG"

          # Replace the literal 'rev:' line under source:
          sed -i "s|^\(\s*rev:\s*\).*|\1$COMMIT_SHA|" ./conda.recipe/recipe.yaml

          # Replace the literal 'version:' line under context:
          sed -i "s|^\(\s*version:\s*\).*|\1$LATEST_TAG|" ./conda.recipe/recipe.yaml
      - name: Build conda package
        uses: prefix-dev/rattler-build-action@v0.2.34
        with:
          build-args: -c khanlab -c conda-forge
      - name: Upload package to Khanlab channel
        shell: bash
        env:
          BINSTAR_TOKEN: ${{ secrets.ANACONDA_UPLOAD_TOKEN }}
        run: |
          shopt -s nullglob

          export ANACONDA_API_KEY=$BINSTAR_TOKEN

          EXIT_CODE=0
          for pkg in $(find output -type f \( -name "*.conda" -o -name "*.tar.bz2" \) ); do
            if ! rattler-build upload anaconda --owner khanlab "${pkg}" --force; then
              EXIT_CODE=1
            fi
          done
          exit $EXIT_CODE